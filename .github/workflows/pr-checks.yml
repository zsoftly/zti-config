---
name: PR Checks

on:
  pull_request:
    branches: [main, develop]

jobs:
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"

          # Valid formats: feat:, fix:, docs:, chore:, test:, refactor:
          if ! echo "$PR_TITLE" | grep -qE "^(feat|fix|docs|chore|test|refactor|ci)(\(.+\))?: .+"; then
            echo "Error: PR title must follow format: type(scope): description"
            echo "Valid types: feat, fix, docs, chore, test, refactor, ci"
            echo "Example: feat(roles): add new wazuh role"
            exit 1
          fi

      - name: Check for changelog update
        run: |
          # Check if CHANGELOG.md was updated
          if git diff --name-only origin/main...HEAD | grep -q "CHANGELOG.md"; then
            echo "âœ“ CHANGELOG.md updated"
          else
            echo "Warning: Consider updating CHANGELOG.md"
            # Don't fail, just warn
          fi

  file-changes:
    name: Detect File Changes
    runs-on: ubuntu-latest

    outputs:
      roles: ${{ steps.filter.outputs.roles }}
      playbooks: ${{ steps.filter.outputs.playbooks }}
      collections: ${{ steps.filter.outputs.collections }}
      docs: ${{ steps.filter.outputs.docs }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            roles:
              - 'tools/ansible/roles/**'
            playbooks:
              - 'tools/ansible/playbooks/**'
            collections:
              - 'tools/ansible/collections/**'
            docs:
              - 'docs/**'
              - 'tools/ansible/docs/**'
              - '*.md'

  role-tests:
    name: Test Roles
    runs-on: ubuntu-latest
    needs: file-changes
    if: needs.file-changes.outputs.roles == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          pip install ansible ansible-lint

      - name: Lint roles
        run: |
          for role in tools/ansible/roles/*/; do
            echo "Linting $role..."
            ansible-lint "$role" || exit 1
          done

  playbook-tests:
    name: Test Playbooks
    runs-on: ubuntu-latest
    needs: file-changes
    if: needs.file-changes.outputs.playbooks == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: pip install ansible

      - name: Syntax check playbooks
        run: |
          for playbook in tools/ansible/playbooks/*.yml; do
            echo "Checking $playbook..."
            ansible-playbook --syntax-check "$playbook" || exit 1
          done

  docs-check:
    name: Check Documentation
    runs-on: ubuntu-latest
    needs: file-changes
    if: needs.file-changes.outputs.docs == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for broken links
        uses: lycheeverse/lychee-action@v1
        with:
          args: --verbose --no-progress '**/*.md'
          fail: true
