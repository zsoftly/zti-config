---
# Wazuh Agent Installation
# Minimal setup - policies managed by Wazuh Manager

- name: Detect OS
  ansible.builtin.setup:
    gather_subset: ["!all", "!min", "distribution", "os_family", "architecture"]

- name: Set architecture
  ansible.builtin.set_fact:
    wazuh_arch: "{{ 'aarch64' if ansible_architecture in ['aarch64', 'arm64'] else 'x86_64' }}"

# Debian/Ubuntu
- name: Install on Debian/Ubuntu
  when: ansible_os_family == "Debian"
  block:
    - name: Check GPG key
      ansible.builtin.stat:
        path: /usr/share/keyrings/wazuh-archive-keyring.gpg
      register: wazuh_gpg_key

    - name: Add GPG key
      ansible.builtin.shell: |
        curl -fsSL https://packages.wazuh.com/key/GPG-KEY-WAZUH | \
        gpg --dearmor --batch --yes -o /usr/share/keyrings/wazuh-archive-keyring.gpg
      when: not wazuh_gpg_key.stat.exists or wazuh_gpg_key.stat.size == 0

    - name: Add repository
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/wazuh.list
        content: "deb [signed-by=/usr/share/keyrings/wazuh-archive-keyring.gpg] https://packages.wazuh.com/4.x/apt/ stable main\n"
        mode: "0644"

    - name: Install package
      ansible.builtin.apt:
        name: wazuh-agent
        state: "{{ wazuh_agent_package_state }}"
        update_cache: true

# RHEL/CentOS/Fedora
- name: Install on RedHat
  when: ansible_os_family == "RedHat"
  block:
    - name: Add GPG key
      ansible.builtin.rpm_key:
        key: https://packages.wazuh.com/key/GPG-KEY-WAZUH
        state: present

    - name: Add repository
      ansible.builtin.yum_repository:
        name: wazuh
        description: Wazuh repository
        baseurl: https://packages.wazuh.com/4.x/yum/
        gpgkey: https://packages.wazuh.com/key/GPG-KEY-WAZUH
        gpgcheck: true
        enabled: true

    - name: Install package
      ansible.builtin.yum:
        name: wazuh-agent
        state: "{{ wazuh_agent_package_state }}"

# Configuration
- name: Deploy config
  ansible.builtin.template:
    src: ossec.conf.j2
    dest: /var/ossec/etc/ossec.conf
    owner: root
    group: wazuh
    mode: "0644"
  notify: Restart wazuh agent

# Enrollment
- name: Check enrollment
  ansible.builtin.stat:
    path: /var/ossec/etc/client.keys
  register: wazuh_client_keys

- name: Check current group config
  ansible.builtin.slurp:
    src: /var/ossec/etc/.enrolled_groups
  register: wazuh_current_groups
  failed_when: false

- name: Set enrollment needed flag
  ansible.builtin.set_fact:
    # Only enroll if:
    # 1. client.keys doesn't exist or is empty (fresh install), OR
    # 2. Group changed AND .enrolled_groups file exists (explicit re-enrollment)
    # Skip re-enrollment for existing agents without .enrolled_groups (legacy/UI-managed)
    wazuh_needs_enrollment: >-
      {{
        not wazuh_client_keys.stat.exists or
        wazuh_client_keys.stat.size == 0 or
        (
          wazuh_current_groups.content is defined and
          (wazuh_current_groups.content | b64decode | trim) != (wazuh_agent_group | default(''))
        )
      }}

- name: Remove stale enrollment (group changed)
  when:
    - wazuh_needs_enrollment
    - wazuh_client_keys.stat.exists
    - wazuh_client_keys.stat.size > 0
  block:
    - name: Stop agent before re-enrollment
      ansible.builtin.systemd:
        name: wazuh-agent
        state: stopped

    - name: Remove client.keys for re-enrollment
      ansible.builtin.file:
        path: /var/ossec/etc/client.keys
        state: absent

- name: Enroll agent
  when: wazuh_needs_enrollment
  ansible.builtin.command:
    cmd: >-
      /var/ossec/bin/agent-auth
      -m {{ wazuh_manager_address }}
      -p {{ wazuh_manager_enrollment_port }}
      -A {{ wazuh_agent_name }}
      {{ '-G ' + wazuh_agent_group if wazuh_agent_group | length > 0 else '' }}
      {{ '-P ' + wazuh_authd_password if wazuh_authd_password | length > 0 else '' }}
  register: wazuh_enrollment
  changed_when: wazuh_enrollment.rc == 0
  failed_when: wazuh_enrollment.rc != 0
  timeout: 30
  no_log: false  # Temporarily disabled to debug enrollment issues

- name: Save enrolled group config
  when: wazuh_needs_enrollment
  ansible.builtin.copy:
    content: "{{ wazuh_agent_group | default('') }}"
    dest: /var/ossec/etc/.enrolled_groups
    mode: "0600"

# Remote commands configuration
- name: Configure remote commands
  ansible.builtin.lineinfile:
    path: /var/ossec/etc/local_internal_options.conf
    regexp: "^wazuh\\.remote_commands="
    line: "wazuh.remote_commands={{ '1' if wazuh_remote_commands_enabled else '0' }}"
    create: true
    mode: "0640"
    owner: root
    group: wazuh
  notify: Restart wazuh agent

# Service
- name: Start service
  ansible.builtin.systemd:
    name: wazuh-agent
    state: "{{ wazuh_agent_service_state }}"
    enabled: "{{ wazuh_agent_service_enabled }}"
    daemon_reload: true

- name: Verify connection
  ansible.builtin.wait_for:
    path: /var/ossec/logs/ossec.log
    search_regex: "Connected to the server"
    timeout: 30
  ignore_errors: true
  register: wazuh_connection

- name: Status
  ansible.builtin.debug:
    msg: "{{ 'Connected to manager' if wazuh_connection is succeeded else 'Connecting... check /var/ossec/logs/ossec.log' }}"
