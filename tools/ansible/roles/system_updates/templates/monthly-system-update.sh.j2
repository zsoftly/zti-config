#!/bin/bash
#
# Monthly System Update Script
# Purpose: Apply OS patches and firmware updates
# Generated by: Ansible (system_updates role)
# Last updated: {{ ansible_date_time.iso8601 }}
#
# Usage:
#   sudo /usr/local/bin/monthly-system-update.sh [--check-only] [--no-reboot]
#
# Options:
#   --check-only    Check for updates but don't apply them
#   --no-reboot     Skip automatic reboot even if required
#   --help          Show this help message

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
LOG_DIR="/var/log/system-updates"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
LOG_FILE="${LOG_DIR}/${TIMESTAMP}-$(hostname).log"
REPORT_FILE="${LOG_DIR}/${TIMESTAMP}-$(hostname)-report.md"

# Flags
CHECK_ONLY=false
NO_REBOOT=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --check-only)
            CHECK_ONLY=true
            shift
            ;;
        --no-reboot)
            NO_REBOOT=true
            shift
            ;;
        --help)
            grep '^#' "$0" | grep -v '#!/bin/bash' | sed 's/^# //'
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Run with --help for usage"
            exit 1
            ;;
    esac
done

# Ensure running as root
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}Error: This script must be run as root${NC}"
   exit 1
fi

# Create log directory
mkdir -p "$LOG_DIR"

# Logging function
log() {
    echo -e "$1" | tee -a "$LOG_FILE"
}

log_section() {
    log "\n${BLUE}========================================${NC}"
    log "${BLUE}$1${NC}"
    log "${BLUE}========================================${NC}\n"
}

# Start logging
log_section "Monthly System Update - $(hostname)"
log "Started: $(date)"
log "Mode: $([ "$CHECK_ONLY" = true ] && echo 'CHECK ONLY' || echo 'APPLY UPDATES')"
log "Operator: ${SUDO_USER:-root}"

# Initialize counters
OS_UPDATES_AVAILABLE=0
OS_UPDATES_APPLIED=0
FIRMWARE_UPDATES_AVAILABLE=0
FIRMWARE_UPDATES_APPLIED=0
REBOOT_REQUIRED=false

# ============================================================================
# STEP 1: OS PACKAGE UPDATES
# ============================================================================
log_section "Step 1: Operating System Updates"

log "${YELLOW}Updating package cache...${NC}"
apt-get update >> "$LOG_FILE" 2>&1

log "${YELLOW}Checking for available updates...${NC}"
UPDATES_LIST=$(apt list --upgradable 2>/dev/null | grep -v "Listing..." || true)
OS_UPDATES_AVAILABLE=$(echo "$UPDATES_LIST" | grep -c "upgradable" || echo "0")

if [ "$OS_UPDATES_AVAILABLE" -gt 0 ]; then
    log "${GREEN}Found $OS_UPDATES_AVAILABLE OS package updates available${NC}"

    if [ "$CHECK_ONLY" = false ]; then
        log "${YELLOW}Applying OS updates...${NC}"

        # Perform upgrade
        DEBIAN_FRONTEND=noninteractive apt-get upgrade -y >> "$LOG_FILE" 2>&1

        # Clean up
        log "${YELLOW}Removing unnecessary packages...${NC}"
        DEBIAN_FRONTEND=noninteractive apt-get autoremove -y >> "$LOG_FILE" 2>&1
        DEBIAN_FRONTEND=noninteractive apt-get autoclean -y >> "$LOG_FILE" 2>&1

        OS_UPDATES_APPLIED=$OS_UPDATES_AVAILABLE
        log "${GREEN}Successfully applied $OS_UPDATES_APPLIED OS updates${NC}"

        # Check if reboot is required
        if [ -f /var/run/reboot-required ]; then
            REBOOT_REQUIRED=true
            log "${YELLOW}⚠️  OS updates require system reboot${NC}"
        fi
    else
        log "${BLUE}Check-only mode: Skipping OS update application${NC}"
        echo "$UPDATES_LIST" >> "$LOG_FILE"
    fi
else
    log "${GREEN}No OS updates available - system is up to date${NC}"
fi

# ============================================================================
# STEP 2: FIRMWARE UPDATES
# ============================================================================
log_section "Step 2: Firmware Updates"

# Check if fwupd is installed
if ! command -v fwupdmgr &> /dev/null; then
    log "${YELLOW}fwupd not installed - installing...${NC}"
    DEBIAN_FRONTEND=noninteractive apt-get install -y fwupd fwupd-signed >> "$LOG_FILE" 2>&1
fi

log "${YELLOW}Refreshing firmware metadata...${NC}"
fwupdmgr refresh --force >> "$LOG_FILE" 2>&1 || true

log "${YELLOW}Checking for firmware updates...${NC}"
if fwupdmgr get-updates >> "$LOG_FILE" 2>&1; then
    FIRMWARE_UPDATES_AVAILABLE=$(fwupdmgr get-updates 2>/dev/null | grep -c "Update available" || echo "0")

    if [ "$FIRMWARE_UPDATES_AVAILABLE" -gt 0 ]; then
        log "${GREEN}Found $FIRMWARE_UPDATES_AVAILABLE firmware updates available${NC}"

        if [ "$CHECK_ONLY" = false ]; then
            log "${YELLOW}Applying firmware updates...${NC}"

            # Apply updates
            if fwupdmgr update --no-reboot-check --assume-yes >> "$LOG_FILE" 2>&1; then
                FIRMWARE_UPDATES_APPLIED=$FIRMWARE_UPDATES_AVAILABLE
                log "${GREEN}Successfully applied $FIRMWARE_UPDATES_APPLIED firmware updates${NC}"
                REBOOT_REQUIRED=true
                log "${YELLOW}⚠️  Firmware updates require system reboot${NC}"
            else
                log "${RED}Some firmware updates failed - check logs${NC}"
            fi
        else
            log "${BLUE}Check-only mode: Skipping firmware update application${NC}"
            fwupdmgr get-updates 2>&1 | tee -a "$LOG_FILE"
        fi
    else
        log "${GREEN}No firmware updates available - firmware is up to date${NC}"
    fi
else
    log "${GREEN}No firmware updates available${NC}"
fi

# ============================================================================
# STEP 3: GENERATE REPORT
# ============================================================================
log_section "Step 3: Generating Report"

cat > "$REPORT_FILE" << EOF
# System Update Report

**Date:** $(date '+%Y-%m-%d %H:%M:%S')
**Hostname:** $(hostname)
**Hardware:** $(dmidecode -s system-product-name 2>/dev/null || echo "Unknown")
**Operator:** ${SUDO_USER:-root}
**Mode:** $([ "$CHECK_ONLY" = true ] && echo 'Check Only' || echo 'Apply Updates')

---

## Summary

| Component | Available | Applied | Status |
| --------- | --------- | ------- | ------ |
| OS Packages | $OS_UPDATES_AVAILABLE | $OS_UPDATES_APPLIED | $([ "$OS_UPDATES_APPLIED" -gt 0 ] && echo "✅ Updated" || [ "$OS_UPDATES_AVAILABLE" -gt 0 ] && echo "⚠️ Pending" || echo "✅ Up to date") |
| Firmware | $FIRMWARE_UPDATES_AVAILABLE | $FIRMWARE_UPDATES_APPLIED | $([ "$FIRMWARE_UPDATES_APPLIED" -gt 0 ] && echo "✅ Updated" || [ "$FIRMWARE_UPDATES_AVAILABLE" -gt 0 ] && echo "⚠️ Pending" || echo "✅ Up to date") |

**Reboot Required:** $([ "$REBOOT_REQUIRED" = true ] && echo "⚠️ YES" || echo "No")

---

## OS Package Updates

$(if [ "$OS_UPDATES_AVAILABLE" -gt 0 ]; then
    echo "$UPDATES_LIST"
else
    echo "No updates available"
fi)

---

## Firmware Updates

\`\`\`
$(fwupdmgr get-devices --no-unreported-check 2>&1 | head -100)
\`\`\`

---

## Next Steps

$(if [ "$REBOOT_REQUIRED" = true ]; then
    echo "1. **REBOOT REQUIRED** to apply updates"
    echo "2. After reboot, verify:"
    echo "   - OS: \`apt list --upgradable\`"
    echo "   - Firmware: \`fwupdmgr get-devices\`"
    echo "3. Update docs/FIRMWARE_UPDATE_LOG.md"
elif [ "$CHECK_ONLY" = true ] && [ "$OS_UPDATES_AVAILABLE" -gt 0 -o "$FIRMWARE_UPDATES_AVAILABLE" -gt 0 ]; then
    echo "1. Coordinate physical access (open laptop lids for firmware updates)"
    echo "2. Run update script: \`sudo /usr/local/bin/monthly-system-update.sh\`"
    echo "3. Reboot if required"
    echo "4. Update docs/FIRMWARE_UPDATE_LOG.md"
else
    echo "1. No updates available"
    echo "2. Update docs/FIRMWARE_UPDATE_LOG.md (log check was performed)"
    echo "3. Schedule next monthly check"
fi)

---

**Full Log:** \`$LOG_FILE\`
**Report:** \`$REPORT_FILE\`

EOF

log "${GREEN}Report generated: $REPORT_FILE${NC}"

# ============================================================================
# STEP 4: REBOOT IF REQUIRED
# ============================================================================
if [ "$REBOOT_REQUIRED" = true ] && [ "$NO_REBOOT" = false ] && [ "$CHECK_ONLY" = false ]; then
    log_section "Step 4: Reboot Required"
    log "${YELLOW}⚠️  System reboot required to complete updates${NC}"
    log "${YELLOW}Rebooting in 60 seconds... (Ctrl+C to cancel)${NC}"

    sleep 60
    log "${RED}Rebooting now...${NC}"
    reboot
elif [ "$REBOOT_REQUIRED" = true ]; then
    log_section "Step 4: Reboot Required"
    log "${YELLOW}⚠️  System reboot required but skipped (--no-reboot or --check-only)${NC}"
    log "${YELLOW}Manual reboot needed: sudo reboot${NC}"
fi

# ============================================================================
# COMPLETION
# ============================================================================
log_section "Update Complete"
log "Finished: $(date)"
log "${GREEN}Summary:${NC}"
log "  OS Updates: $OS_UPDATES_APPLIED applied (of $OS_UPDATES_AVAILABLE available)"
log "  Firmware Updates: $FIRMWARE_UPDATES_APPLIED applied (of $FIRMWARE_UPDATES_AVAILABLE available)"
log "  Reboot Required: $([ "$REBOOT_REQUIRED" = true ] && echo 'YES' || echo 'No')"
log ""
log "${BLUE}Full report: $REPORT_FILE${NC}"
log "${BLUE}Full log: $LOG_FILE${NC}"

exit 0
