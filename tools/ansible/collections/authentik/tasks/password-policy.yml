# Configure Password Policy
# Based on NIST SP 800-63 guidelines
---
- name: Get existing password policies
  ansible.builtin.uri:
    url: "{{ authentik_url }}{{ authentik_api_path }}/policies/password/"
    method: GET
    headers:
      Authorization: "Bearer {{ authentik_token | trim }}"
    status_code: 200
  register: existing_password_policies
  check_mode: false

- name: Find existing password policy
  ansible.builtin.set_fact:
    existing_password_policy: "{{ existing_password_policies.json.results | selectattr('name', 'equalto', password_policy.name) | first | default(None) }}"

- name: Set password policy state
  ansible.builtin.set_fact:
    password_policy_exists: "{{ existing_password_policy is not none and existing_password_policy != None }}"
    existing_policy_pk: "{{ existing_password_policy.pk | default('') if existing_password_policy is not none and existing_password_policy != None else '' }}"

- name: Create password policy
  ansible.builtin.uri:
    url: "{{ authentik_url }}{{ authentik_api_path }}/policies/password/"
    method: POST
    headers:
      Authorization: "Bearer {{ authentik_token | trim }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ password_policy.name }}"
      execution_logging: true
      length_min: "{{ password_policy.length_min }}"
      amount_uppercase: "{{ password_policy.amount_uppercase }}"
      amount_lowercase: "{{ password_policy.amount_lowercase }}"
      amount_digits: "{{ password_policy.amount_digits }}"
      amount_symbols: "{{ password_policy.amount_symbols }}"
      check_have_i_been_pwned: "{{ password_policy.check_have_i_been_pwned }}"
      check_zxcvbn: "{{ password_policy.check_zxcvbn }}"
      zxcvbn_score_threshold: "{{ password_policy.zxcvbn_score_threshold }}"
      check_static_rules: "{{ password_policy.check_static_rules }}"
      hibp_allowed_count: 0
    status_code: [200, 201]
  when:
    - not ansible_check_mode
    - not password_policy_exists
  register: created_password_policy

- name: Update existing password policy
  ansible.builtin.uri:
    url: "{{ authentik_url }}{{ authentik_api_path }}/policies/password/{{ existing_policy_pk }}/"
    method: PUT
    headers:
      Authorization: "Bearer {{ authentik_token | trim }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ password_policy.name }}"
      execution_logging: true
      length_min: "{{ password_policy.length_min }}"
      amount_uppercase: "{{ password_policy.amount_uppercase }}"
      amount_lowercase: "{{ password_policy.amount_lowercase }}"
      amount_digits: "{{ password_policy.amount_digits }}"
      amount_symbols: "{{ password_policy.amount_symbols }}"
      check_have_i_been_pwned: "{{ password_policy.check_have_i_been_pwned }}"
      check_zxcvbn: "{{ password_policy.check_zxcvbn }}"
      zxcvbn_score_threshold: "{{ password_policy.zxcvbn_score_threshold }}"
      check_static_rules: "{{ password_policy.check_static_rules }}"
      hibp_allowed_count: 0
    status_code: [200]
  when:
    - not ansible_check_mode
    - password_policy_exists
    - existing_policy_pk | length > 0
  register: updated_password_policy

# Properly determine the policy PK
- name: Set password policy PK from created policy
  ansible.builtin.set_fact:
    password_policy_pk: "{{ created_password_policy.json.pk }}"
  when:
    - created_password_policy is defined
    - created_password_policy is not skipped
    - created_password_policy.json is defined
    - created_password_policy.json.pk is defined

- name: Set password policy PK from existing policy
  ansible.builtin.set_fact:
    password_policy_pk: "{{ existing_policy_pk }}"
  when:
    - password_policy_pk is not defined
    - existing_policy_pk | length > 0

# Password Uniqueness Policy (prevent reuse) - Enterprise feature only
- name: Check if password uniqueness API is available (enterprise)
  ansible.builtin.uri:
    url: "{{ authentik_url }}{{ authentik_api_path }}/policies/password_uniqueness/"
    method: GET
    headers:
      Authorization: "Bearer {{ authentik_token | trim }}"
    status_code: [200, 404]
  register: uniqueness_api_check
  check_mode: false

- name: Skip password uniqueness (enterprise feature)
  ansible.builtin.debug:
    msg: "Password uniqueness policy requires Authentik Enterprise - skipping"
  when: uniqueness_api_check.status == 404

# Bind policy to password stage in authentication flow
- name: Get authentication flow
  ansible.builtin.uri:
    url: "{{ authentik_url }}{{ authentik_api_path }}/flows/instances/?slug=default-authentication-flow"
    method: GET
    headers:
      Authorization: "Bearer {{ authentik_token | trim }}"
    status_code: 200
  register: auth_flow
  check_mode: false

- name: Set authentication flow PK
  ansible.builtin.set_fact:
    auth_flow_pk: "{{ auth_flow.json.results[0].pk }}"
  when: auth_flow.json.results | length > 0

# Get flow stage bindings to find the password stage
- name: Get flow stage bindings
  ansible.builtin.uri:
    url: "{{ authentik_url }}{{ authentik_api_path }}/flows/bindings/?target={{ auth_flow_pk }}"
    method: GET
    headers:
      Authorization: "Bearer {{ authentik_token | trim }}"
    status_code: 200
  register: flow_stage_bindings
  check_mode: false

# Find the example password stage binding
- name: Find password stage binding
  ansible.builtin.set_fact:
    password_stage_binding: "{{ flow_stage_bindings.json.results | selectattr('stage_obj.name', 'defined') | selectattr('stage_obj.name', 'equalto', 'example-authentication-password') | first | default(None) }}"

# Fallback to default password stage if not found
- name: Fallback to default password stage
  ansible.builtin.set_fact:
    password_stage_binding: "{{ flow_stage_bindings.json.results | selectattr('stage_obj.name', 'defined') | selectattr('stage_obj.name', 'equalto', 'default-authentication-password') | first | default(None) }}"
  when: password_stage_binding is none or password_stage_binding == None

- name: Set policy binding target for password stage
  ansible.builtin.set_fact:
    password_policy_binding_target: "{{ password_stage_binding.policybindingmodel_ptr_id }}"
  when: password_stage_binding is not none and password_stage_binding != None

# Get existing policy bindings for this stage
- name: Get existing policy bindings for password stage
  ansible.builtin.uri:
    url: "{{ authentik_url }}{{ authentik_api_path }}/policies/bindings/?target={{ password_policy_binding_target }}"
    method: GET
    headers:
      Authorization: "Bearer {{ authentik_token | trim }}"
    status_code: 200
  register: existing_password_policy_bindings
  check_mode: false
  when: password_policy_binding_target is defined

# Check if password policy is already bound
- name: Check if password policy already bound
  ansible.builtin.set_fact:
    password_policy_binding_exists: "{{ existing_password_policy_bindings.json.results | selectattr('policy', 'defined') | selectattr('policy', 'equalto', password_policy_pk) | list | length > 0 }}"
  when:
    - password_policy_pk is defined
    - password_policy_pk | length > 0
    - existing_password_policy_bindings is defined

- name: Default password policy binding exists to false
  ansible.builtin.set_fact:
    password_policy_binding_exists: false
  when: password_policy_binding_exists is not defined

# Create policy binding
- name: Create policy binding for password policy
  ansible.builtin.uri:
    url: "{{ authentik_url }}{{ authentik_api_path }}/policies/bindings/"
    method: POST
    headers:
      Authorization: "Bearer {{ authentik_token | trim }}"
      Content-Type: "application/json"
    body_format: json
    body:
      policy: "{{ password_policy_pk }}"
      target: "{{ password_policy_binding_target }}"
      order: 0
      enabled: true
      timeout: 30
    status_code: [200, 201]
  when:
    - not ansible_check_mode
    - password_policy_pk is defined
    - password_policy_pk | length > 0
    - password_policy_binding_target is defined
    - not password_policy_binding_exists
  register: created_password_policy_binding

- name: Display password policy status
  ansible.builtin.debug:
    msg: "Password policy '{{ password_policy.name }}' configured (min_length={{ password_policy.length_min }}, HIBP={{ password_policy.check_have_i_been_pwned }})"
