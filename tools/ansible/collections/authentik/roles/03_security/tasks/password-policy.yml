# Configure Password Policy
# Based on NIST SP 800-63 guidelines
# Supports: --check --diff for dry runs
---
- name: Get existing password policies
  ansible.builtin.uri:
    url: "{{ authentik_url }}{{ authentik_api_path }}/policies/password/"
    method: GET
    headers:
      Authorization: "Bearer {{ authentik_token | trim }}"
    status_code: 200
  register: existing_password_policies
  check_mode: false

- name: Check if password policy exists
  ansible.builtin.set_fact:
    password_policy_exists: "{{ password_policy.name in (existing_password_policies.json.results | map(attribute='name') | list) }}"
    existing_policy_pk: "{{ (existing_password_policies.json.results | selectattr('name', 'equalto', password_policy.name) | first).pk | default('') }}"

- name: Show password policy that would be created (check mode)
  ansible.builtin.debug:
    msg: "Would create password policy: {{ password_policy.name }}"
  when: ansible_check_mode and not password_policy_exists

- name: Show password policy that would be updated (check mode)
  ansible.builtin.debug:
    msg: "Would update password policy: {{ password_policy.name }}"
  when: ansible_check_mode and password_policy_exists

- name: Create password policy
  ansible.builtin.uri:
    url: "{{ authentik_url }}{{ authentik_api_path }}/policies/password/"
    method: POST
    headers:
      Authorization: "Bearer {{ authentik_token | trim }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ password_policy.name }}"
      execution_logging: true
      length_min: "{{ password_policy.length_min }}"
      amount_uppercase: "{{ password_policy.amount_uppercase }}"
      amount_lowercase: "{{ password_policy.amount_lowercase }}"
      amount_digits: "{{ password_policy.amount_digits }}"
      amount_symbols: "{{ password_policy.amount_symbols }}"
      check_have_i_been_pwned: "{{ password_policy.check_have_i_been_pwned }}"
      check_zxcvbn: "{{ password_policy.check_zxcvbn }}"
      zxcvbn_score_threshold: "{{ password_policy.zxcvbn_score_threshold }}"
      check_static_rules: "{{ password_policy.check_static_rules }}"
      hibp_allowed_count: 0
    status_code: [200, 201]
  when:
    - not ansible_check_mode
    - not password_policy_exists
  register: created_password_policy

- name: Update existing password policy
  ansible.builtin.uri:
    url: "{{ authentik_url }}{{ authentik_api_path }}/policies/password/{{ existing_policy_pk }}/"
    method: PUT
    headers:
      Authorization: "Bearer {{ authentik_token | trim }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ password_policy.name }}"
      execution_logging: true
      length_min: "{{ password_policy.length_min }}"
      amount_uppercase: "{{ password_policy.amount_uppercase }}"
      amount_lowercase: "{{ password_policy.amount_lowercase }}"
      amount_digits: "{{ password_policy.amount_digits }}"
      amount_symbols: "{{ password_policy.amount_symbols }}"
      check_have_i_been_pwned: "{{ password_policy.check_have_i_been_pwned }}"
      check_zxcvbn: "{{ password_policy.check_zxcvbn }}"
      zxcvbn_score_threshold: "{{ password_policy.zxcvbn_score_threshold }}"
      check_static_rules: "{{ password_policy.check_static_rules }}"
      hibp_allowed_count: 0
    status_code: [200]
  when:
    - not ansible_check_mode
    - password_policy_exists
  register: updated_password_policy

- name: Get password policy PK
  ansible.builtin.set_fact:
    password_policy_pk: "{{ created_password_policy.json.pk | default(existing_policy_pk) }}"

# Password Uniqueness Policy - Enterprise feature only
- name: Check if password uniqueness API is available (enterprise)
  ansible.builtin.uri:
    url: "{{ authentik_url }}{{ authentik_api_path }}/policies/password_uniqueness/"
    method: GET
    headers:
      Authorization: "Bearer {{ authentik_token | trim }}"
    status_code: [200, 404]
  register: uniqueness_api_check
  check_mode: false

- name: Display password policy status
  ansible.builtin.debug:
    msg: "Password policy: {{ password_policy.name }} (min_length={{ password_policy.length_min }}, hibp={{ password_policy.check_have_i_been_pwned }})"
