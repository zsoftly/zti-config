---
# System configuration role - kernel params and firewall
# Matches WireGuard routing behavior for VPC access

- name: Enable IP forwarding
  ansible.posix.sysctl:
    name: "{{ item }}"
    value: "1"
    state: present
    sysctl_set: true
    reload: true
  loop:
    - net.ipv4.ip_forward
    - net.ipv6.conf.all.forwarding
    - net.ipv4.conf.all.src_valid_mark

# =============================================================================
# UDP GRO Forwarding Optimization (Tailscale Performance Best Practice)
# =============================================================================
# Enables UDP Generic Receive Offload forwarding for 10Gbps+ throughput
# Required for exit nodes and subnet routers (Linux 6.2+)
# Ref: https://tailscale.com/kb/1320/performance-best-practices

- name: Get primary network interface
  ansible.builtin.shell: ip -o route get 8.8.8.8 | cut -f 5 -d " "
  register: primary_netdev
  changed_when: false

- name: Configure UDP GRO forwarding for Tailscale performance
  ansible.builtin.command:
    cmd: ethtool -K {{ primary_netdev.stdout }} rx-udp-gro-forwarding on rx-gro-list off
  register: ethtool_result
  changed_when: ethtool_result.rc == 0
  failed_when: false

- name: Create networkd-dispatcher routable.d directory
  ansible.builtin.file:
    path: /etc/networkd-dispatcher/routable.d
    state: directory
    mode: "0755"
  when: ansible_os_family == "Debian"

- name: Create persistent ethtool script for UDP GRO
  ansible.builtin.copy:
    content: |
      #!/bin/sh
      # Tailscale UDP GRO forwarding optimization
      # Auto-generated by Ansible
      ethtool -K {{ primary_netdev.stdout }} rx-udp-gro-forwarding on rx-gro-list off
    dest: /etc/networkd-dispatcher/routable.d/50-tailscale
    mode: "0755"
  when:
    - ansible_os_family == "Debian"
    - primary_netdev.stdout | length > 0

# FORWARD rules - allow VPN traffic to be routed
- name: Allow FORWARD for tailscale interface (IPv4)
  ansible.builtin.iptables:
    chain: FORWARD
    in_interface: tailscale0
    jump: ACCEPT
    state: present
    comment: "Allow VPN client traffic forwarding"

- name: Allow FORWARD for tailscale interface (IPv6)
  ansible.builtin.iptables:
    chain: FORWARD
    in_interface: tailscale0
    jump: ACCEPT
    ip_version: ipv6
    state: present
    comment: "Allow VPN client traffic forwarding (IPv6)"

# =============================================================================
# DNS NAT for Exit Node
# =============================================================================
# Masquerade DNS traffic (UDP/TCP port 53) for exit node clients
# Required for lab nodes using headscale as exit node to resolve DNS
# Without this, DNS queries to 8.8.8.8, 1.1.1.1, etc. will timeout

- name: Masquerade DNS traffic for exit node (UDP)
  ansible.builtin.iptables:
    table: nat
    chain: POSTROUTING
    out_interface: "{{ ansible_default_ipv4.interface }}"
    protocol: udp
    destination_port: "53"
    jump: MASQUERADE
    state: present
    comment: "NAT DNS queries from exit node clients (UDP)"

- name: Masquerade DNS traffic for exit node (TCP)
  ansible.builtin.iptables:
    table: nat
    chain: POSTROUTING
    out_interface: "{{ ansible_default_ipv4.interface }}"
    protocol: tcp
    destination_port: "53"
    jump: MASQUERADE
    state: present
    comment: "NAT DNS queries from exit node clients (TCP)"

# Selective NAT - preserve source IP for VPC traffic, masquerade internet
# This matches WireGuard behavior: VPC sees client IP, not server IP
- name: Remove old blanket masquerade rule (IPv4)
  ansible.builtin.iptables:
    table: nat
    chain: POSTROUTING
    out_interface: "{{ ansible_default_ipv4.interface }}"
    jump: MASQUERADE
    state: absent
  failed_when: false

- name: Configure selective masquerade - exclude VPC (IPv4)
  ansible.builtin.shell: |
    # Remove any existing masquerade rules for this interface
    iptables -t nat -D POSTROUTING -o {{ ansible_default_ipv4.interface }} -j MASQUERADE 2>/dev/null || true
    # Add selective masquerade: skip VPC traffic (preserve source IP)
    iptables -t nat -C POSTROUTING -o {{ ansible_default_ipv4.interface }} ! -d {{ aws_vpc_cidr }} -j MASQUERADE 2>/dev/null || \
    iptables -t nat -A POSTROUTING -o {{ ansible_default_ipv4.interface }} ! -d {{ aws_vpc_cidr }} -j MASQUERADE
  register: masq_ipv4
  changed_when: "'Adding' in masq_ipv4.stderr or masq_ipv4.rc == 0"

- name: Configure selective masquerade - exclude VPC (IPv6)
  ansible.builtin.shell: |
    # Remove any existing masquerade rules for this interface
    ip6tables -t nat -D POSTROUTING -o {{ ansible_default_ipv4.interface }} -j MASQUERADE 2>/dev/null || true
    # Add masquerade for internet traffic (IPv6 VPC handled by AWS)
    ip6tables -t nat -C POSTROUTING -o {{ ansible_default_ipv4.interface }} -j MASQUERADE 2>/dev/null || \
    ip6tables -t nat -A POSTROUTING -o {{ ansible_default_ipv4.interface }} -j MASQUERADE
  register: masq_ipv6
  changed_when: "'Adding' in masq_ipv6.stderr or masq_ipv6.rc == 0"

- name: Persist iptables rules (Debian/Ubuntu)
  ansible.builtin.command:
    cmd: netfilter-persistent save
  changed_when: true
  check_mode: false
  when:
    - ansible_os_family == 'Debian'
    - not ansible_check_mode

- name: Persist iptables rules (RHEL-based)
  ansible.builtin.shell:
    cmd: "{{ item }}"
  loop:
    - iptables-save > /etc/sysconfig/iptables
    - ip6tables-save > /etc/sysconfig/ip6tables
  changed_when: true
  check_mode: false
  when:
    - ansible_os_family == 'RedHat'
    - not ansible_check_mode
