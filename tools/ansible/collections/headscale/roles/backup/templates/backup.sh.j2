#!/bin/bash
set -euo pipefail

# Headscale Backup Script - Generated by Ansible

BACKUP_DIR="/opt/headscale/backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
S3_BUCKET="{{ headscale_backup_bucket }}"

mkdir -p "$BACKUP_DIR"

echo "[INFO] Starting backup: $TIMESTAMP"

# Backup Headscale data (SQLite database + config)
# Stop briefly to ensure clean backup
docker compose -f /opt/headscale/docker-compose.yml stop headscale

# Copy SQLite database and config
cp -r /var/lib/docker/volumes/headscale_headscale-data/_data "$BACKUP_DIR/data_$TIMESTAMP"
cp -r /opt/headscale/config "$BACKUP_DIR/config_$TIMESTAMP"

# Restart Headscale
docker compose -f /opt/headscale/docker-compose.yml start headscale

# Create tarball
cd "$BACKUP_DIR"
tar -czf "headscale_backup_$TIMESTAMP.tar.gz" "data_$TIMESTAMP" "config_$TIMESTAMP"
rm -rf "data_$TIMESTAMP" "config_$TIMESTAMP"

echo "[INFO] Backup archive created"

# Upload to S3 with server-side encryption
if command -v aws &> /dev/null; then
  aws s3 cp "$BACKUP_DIR/headscale_backup_$TIMESTAMP.tar.gz" \
    "s3://$S3_BUCKET/backups/" \
    --sse AES256
  echo "[INFO] Uploaded to S3"
fi

# Keep only last {{ headscale_backup_retention_days }} days of local backups
find "$BACKUP_DIR" -type f -mtime +{{ headscale_backup_retention_days }} -delete

echo "[OK] Backup completed: $TIMESTAMP"
