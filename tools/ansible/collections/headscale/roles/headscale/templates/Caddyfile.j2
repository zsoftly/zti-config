# Caddyfile for Headscale - Generated by Ansible
# Do not edit directly - changes will be overwritten

{
    email {{ headscale_acme_email | default('admin@example.com') }}
}

{{ headscale_domain }} {
{% if headscale_acme_staging | default(false) %}
    # Using Let's Encrypt staging (untrusted - for testing only)
    tls {
        issuer acme {
            dir https://acme-staging-v02.api.letsencrypt.org/directory
        }
    }
{% else %}
    # Let's Encrypt production (default)
    tls {
        issuer acme
    }
    # ZeroSSL via ACME (alternative - avoids Let's Encrypt rate limits)
    # Commented out in favor of Let's Encrypt - uncomment if rate limited
    # tls {
    #     issuer acme {
    #         dir https://acme.zerossl.com/v2/DV90
    #         email {{ headscale_acme_email | default('admin@example.com') }}
    #     }
    # }
{% endif %}
{% if headplane_enabled | default(true) %}
    # Admin UI at /admin (Headplane on port 3000)
    handle /admin* {
        reverse_proxy headplane:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
{% endif %}

    # Headscale API and control plane (everything else)
    handle {
        reverse_proxy headscale:8080 {
            # Pass original host header
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}

            # Enable WebSocket support for control plane
            transport http {
                keepalive 60s
                keepalive_idle_conns 10
            }
        }
    }

    # Enable compression
    encode gzip

    # Logging
    log {
        output stdout
        format console
        level INFO
    }
}
