---
# Headscale Docker Compose - Generated by Ansible
# Do not edit directly - changes will be overwritten

services:
  caddy:
    image: caddy:2-alpine
    container_name: headscale-caddy
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data/caddy
      - caddy-config:/config/caddy
    ports:
      - "80:80"
      - "443:443"
    restart: unless-stopped
    depends_on:
      - headscale
    networks:
      - headscale

  headscale:
    image: headscale/headscale:{{ headscale_version }}
    container_name: headscale
    command: serve
    volumes:
      - ./config:/etc/headscale
      - headscale-data:/var/lib/headscale
    ports:
      - "127.0.0.1:8080:8080"   # HTTP API (internal only)
{% if headscale_metrics_enabled | default(true) %}
      - "127.0.0.1:{{ headscale_metrics_port | default(9090) }}:9090"  # Metrics (internal only)
{% endif %}
      - "3478:3478/udp"         # DERP/STUN relay
    restart: unless-stopped
    networks:
      - headscale

{% if headplane_enabled | default(true) %}
  headplane:
    image: ghcr.io/tale/headplane:{{ headplane_version }}
    container_name: headplane
    volumes:
      # Headplane config
      - ./config/headplane.yaml:/etc/headplane/config.yaml:ro
      # Headscale config (read-only - file mode ACL requires Ansible edits)
      - ./config:/etc/headscale:ro
      # Headplane data directory (state storage)
      - headplane-data:/var/lib/headplane
    restart: unless-stopped
    depends_on:
      - headscale
    networks:
      - headscale
{% endif %}

networks:
  headscale:
    driver: bridge

volumes:
  caddy-data:
  caddy-config:
  headscale-data:
{% if headplane_enabled | default(true) %}
  headplane-data:
{% endif %}
